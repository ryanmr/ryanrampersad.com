---
import Footer from "../components/footer/Footer.astro";
import PageTitle from "../components/PageTitle.astro";
import Layout from "../layouts/Layout.astro";

import {
  getSections,
  loadYearData,
  getYearSummaries,
  getCurrentYear,
} from "../components/history/history";
import HistoryDisplay from "../components/history/HistoryDisplay.astro";
import HistoryRange from "../components/history/HistoryRange.astro";
import HistoryYearNav from "../components/history/HistoryYearNav.astro";
import HistoryMonthNav from "../components/history/HistoryMonthNav.astro";

const currentYear = getCurrentYear();
const yearSummaries = await getYearSummaries();

// Load current year data, fallback to most recent available year if current year has no data
let displayYear = currentYear;
let data;
try {
  data = await loadYearData(currentYear);
} catch {
  // Current year might not have data yet, use most recent
  displayYear = yearSummaries[0]?.year ?? currentYear;
  data = await loadYearData(displayYear);
}

const sections = getSections(data);
---

<Layout
  title="Work History â‡’ Ryan Rampersad"
  description="A history of my work"
>
  <PageTitle />

  <div class="mx-auto max-w-3xl px-4">
    <h1 class="mb-8 text-center text-2xl font-bold">{displayYear} - History</h1>

    <div class="mb-8 rounded-lg border border-stone-700 bg-stone-800/50 p-4">
      <div class="mb-4">
        <p class="mb-2 text-center text-xs uppercase tracking-wide text-stone-500">Year</p>
        <HistoryYearNav years={yearSummaries} activeYear={displayYear} mainYear={displayYear} />
      </div>
      <hr class="border-stone-700" />
      <div class="mt-4">
        <p class="mb-2 text-center text-xs uppercase tracking-wide text-stone-500">Month</p>
        <HistoryMonthNav sections={sections} />
      </div>
    </div>

    <HistoryDisplay data={sections} />

    <div class="mt-12 rounded-lg border border-stone-700 bg-stone-800/50 p-4">
      <p class="mb-3 text-center text-xs uppercase tracking-wide text-stone-500">Browse by Year</p>
      <HistoryYearNav years={yearSummaries} activeYear={displayYear} mainYear={displayYear} />
    </div>
  </div>

  <HistoryRange />

  <Footer />
</Layout>
